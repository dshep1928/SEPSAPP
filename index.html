<script>
const $ = id => document.getElementById(id);

function showScreen(id) {
    ["targetScreen","janetScreen"].forEach(s=>$(s).classList.add("hidden"));
    $(id).classList.remove("hidden");
}

$("chooseJanet").onclick = () => showScreen("janetScreen");

$("scope").onchange = () => {
    const show = ["single","multiple"].includes($("scope").value);
    $("namesGroup").style.display = show ? "block" : "none";
};

$("untilCanceled").onchange = () => {
    $("endDate").disabled = $("untilCanceled").checked;
};

$("generateBtn").onclick = () => {
    const data = {
        goal: $("goal").value.trim(),
        scope: $("scope").value,
        names: $("names").value.split(";").map(n=>n.trim()).filter(Boolean),
        interpretation: $("interpretation").value,
        awareness: $("awareness").value,
        untilCanceled: $("untilCanceled").checked,
        endDate: $("endDate").value,
        psych: {
            guilt: $("guilt").checked,
            anxiety: $("anxiety").checked,
            comparison: $("comparison").checked,
            paralysis: $("paralysis").checked
        }
    };

    // ---------- CREATE PROMPT ----------
    let prompt =
`Janet, execute the following directive precisely:

Goal:
${data.goal || "[Missing]"}

Target Scope:
${data.scope}${data.names.length ? " (" + data.names.join(", ") + ")" : ""}

Interpretation Mode:
${data.interpretation}

Awareness Level:
${data.awareness}

Duration:
${data.untilCanceled ? "Until canceled" : (data.endDate || "[Unspecified]")}`;

    const psychMods = Object.entries(data.psych)
        .filter(([k,v]) => v)
        .map(([k]) => k.replace(/^\w/, c => c.toUpperCase()))
        .join(", ");

    if (psychMods) {
        prompt += `\n\nPsychological Sensitivities:\n${psychMods}`;
    }

    prompt += `

Execution Rule:
Ask for clarification if ANY variable is undefined before acting.`;

    // SHOW PROMPT ON SCREEN
    $("prompt").textContent = prompt;

    // ---------- ANALYSIS ----------
    let issues = [];
    if (!data.goal) issues.push("Missing goal.");
    if (["single","multiple"].includes(data.scope) && data.names.length === 0)
        issues.push("Scope requires names but none provided.");
    if (data.untilCanceled && data.endDate)
        issues.push("Duration conflict: end date + until canceled.");

    $("analysis").textContent =
        issues.length ? issues.join("\n") : "No stability issues detected.";

    // MAKE OUTPUT VISIBLE
    $("outputs").classList.remove("hidden");
};

$("simulateBtn").onclick = async () => {
    const builtPrompt = $("prompt").textContent;

    const finalSim =
`You are Janet from The Good Place.
Simulate a scene in the Neighborhood based on this directive:

${builtPrompt}

Respond with:
- Dialogue
- Reactions
- Environmental effects
- Emotional tone

Begin simulation now.`;

    await navigator.clipboard.writeText(finalSim);

    alert("Simulation prompt copied! Now opening ChatGPT...");

    window.open("https://chat.openai.com/", "_blank");
};
</script>
